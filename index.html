<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Calculator</title>
    <!-- Link to the CSS file in the static folder -->
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Salary Calculator</h1>

        <!-- Section to display messages -->
        <div id="message" style="margin-bottom: 20px; color: green;"></div>

        <!-- Stopwatch and real-time salary display -->
        <div style="margin-bottom: 20px;">
            <p>Stopwatch: <span id="stopwatch">00:00:00</span></p>
            <p>Earned Salary: <span id="earnedSalary">$0.00</span></p>
        </div>

        <!-- Buttons for API actions -->
        <button onclick="startShift()">Start Shift</button>
        <button onclick="stopShift()">Stop Shift</button>
        <button onclick="resetCalculator()">Reset Calculator</button>

        <!-- Input field to set the hourly rate -->
        <div style="margin: 20px 0;">
            <label for="hourlyRate">Set Hourly Rate:</label>
            <input type="number" id="hourlyRate" placeholder="Enter hourly rate" />
            <button onclick="setHourlyRate()">Update Rate</button>
        </div>
    </div>

    <!-- JavaScript to handle API requests and real-time updates -->
    <script>
        const apiUrl = "http://127.0.0.1:5000";  // Ensure backend is running at this address
        let stopwatchInterval = null;
        let elapsedTime = 0;

        function displayMessage(message, isError = false) {
            const messageDiv = document.getElementById("message");
            messageDiv.style.color = isError ? "red" : "green";
            messageDiv.textContent = message;

            // Clear the message after 10 seconds
            setTimeout(() => {
                messageDiv.textContent = "";
            }, 10000);
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${hrs}:${mins}:${secs}`;
        }

        function updateStopwatch() {
            document.getElementById("stopwatch").textContent = formatTime(elapsedTime);
        }

        function startStopwatch() {
            if (!stopwatchInterval) {
                stopwatchInterval = setInterval(() => {
                    elapsedTime++;
                    updateStopwatch();
                    updateSalary();
                }, 1000);
            }
        }

        function stopStopwatch() {
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
        }

        async function updateSalary() {
            try {
                const response = await fetch(`${apiUrl}/get_salary`);
                const data = await response.json();
                if (response.ok) {
                    document.getElementById("earnedSalary").textContent = `$${data.earned_salary}`;
                } else {
                    displayMessage(data.error || "Failed to update salary!", true);
                }
            } catch (error) {
                displayMessage("Failed to fetch salary!", true);
            }
        }

        async function startShift() {
            try {
                const response = await fetch(`${apiUrl}/start`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({})  // Prevent empty-body issues
                });

                const data = await response.json();
                if (response.ok) {
                    displayMessage(data.message);
                    elapsedTime = 0;
                    startStopwatch();
                } else {
                    displayMessage(data.error || "Failed to start shift!", true);
                }
            } catch (error) {
                displayMessage("Error: Could not connect to server!", true);
                console.error(error);
            }
        }

        async function stopShift() {
            try {
                const response = await fetch(`${apiUrl}/stop`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });

                const data = await response.json();
                if (response.ok) {
                    displayMessage(data.message);
                    stopStopwatch();
                } else {
                    displayMessage(data.error || "Failed to stop shift!", true);
                }
            } catch (error) {
                displayMessage("Error: Could not connect to server!", true);
                console.error(error);
            }
        }

        async function resetCalculator() {
            try {
                const response = await fetch(`${apiUrl}/reset`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });

                const data = await response.json();
                if (response.ok) {
                    displayMessage(data.message);
                    elapsedTime = 0;
                    updateStopwatch();
                    document.getElementById("earnedSalary").textContent = "$0.00";
                    stopStopwatch();
                } else {
                    displayMessage(data.error || "Failed to reset calculator!", true);
                }
            } catch (error) {
                displayMessage("Error: Could not connect to server!", true);
                console.error(error);
            }
        }

        async function setHourlyRate() {
            const hourlyRate = document.getElementById("hourlyRate").value;
            if (!hourlyRate) {
                displayMessage("Please enter a valid hourly rate!", true);
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/set_rate`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ hourly_rate: parseFloat(hourlyRate) }),
                });
                const data = await response.json();
                displayMessage(data.message || data.error, !response.ok);
            } catch (error) {
                displayMessage("Failed to update hourly rate!", true);
                console.error(error);
            }
        }
    </script>
</body>
</html>
